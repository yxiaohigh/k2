<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>数据显示</title>
  <style>
    body {
      margin: 0;
      background: #e8edf5;
      font-family: 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Arial', sans-serif;
      color: #232d3c;
    }

    .navbar {
      width: 100%;
      height: 56px;
      background: #2563eb;
      color: #fff;
      display: flex;
      align-items: center;
      padding-left: 32px;
      font-size: 22px;
      letter-spacing: 2px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .container {
      max-width: 1800px;
      margin: 32px auto;
      display: flex;
      flex-direction: row;
      gap: 32px;
      justify-content: center;
      align-items: flex-start;
    }

    .side-card {
      background: #f5f7fa;
      border-radius: 12px;
      box-shadow: 0 2px 16px rgba(37, 99, 235, 0.10);
      padding: 32px 16px;
      min-width: 180px;
      max-width: 220px;
      height: 800px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      align-items: center;
      justify-content: center;
    }

    .main-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 16px rgba(37, 99, 235, 0.10);
      padding: 32px 40px;
      flex: 1;
      min-width: 1100px;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }



    .btn {
      background: linear-gradient(90deg, #2563eb 0%, #1e40af 100%);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 12px 36px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.18);
      transition: background 0.2s;
      margin-bottom: 10px;
    }

    .btn:hover {
      background: linear-gradient(90deg, #1e40af 0%, #2563eb 100%);
    }

    .select {
      padding: 10px 24px;
      border-radius: 6px;
      border: 1px solid #dbeafe;
      background: #f5f7fa;
      font-size: 16px;
      color: #232d3c;
      outline: none;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .chart-card {
      background: #f5f7fa;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(37, 99, 235, 0.07);
      padding: 22px 22px 10px 22px;
      margin-bottom: 18px;
      border: 1px solid #dbeafe;
    }

    .chart-title {
      font-size: 20px;
      color: #2563eb;
      margin-bottom: 12px;
      font-weight: 500;
      letter-spacing: 1px;
    }

    .value-summary {
      background: #fff;
      border-radius: 8px;
      border: 1px solid #dbeafe;
      padding: 18px 10px;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    .value-row {
      display: flex;
      gap: 18px;
      font-size: 17px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: space-between;

    }

    .value-label {
      color: #2563eb;
      font-weight: 500;
      min-width: 70px;
      text-align: right;
    }

    .value-data {
      color: #232d3c;
      font-family: 'Consolas', 'Menlo', 'Monaco', 'monospace';
      font-size: 17px;
      min-width: 50px;
      text-align: left;
    }

    .showshow {
      width: 100%;
      min-height: 120px;
      border-radius: 8px;
      border: 1px solid #dbeafe;
      background: #f5f7fa;
      font-size: 15px;
      padding: 10px;
      color: #232d3c;
      resize: none;
      box-sizing: border-box;
      margin-bottom: 10px;
      font-family: 'Consolas', 'Menlo', 'Monaco', 'monospace';
      letter-spacing: 1px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
</head>

<body>
  <div class="navbar">数据可视化工具</div>
  <div class="container">
    <div class="side-card">
      <button id="btnOpen" class="btn">连接设备</button>
      <div class="value-summary" id="valueSummary">
        <div class="value-row">
          <span class="value-label">电压:</span>
          <span class="value-data" id="summaryVoltage">--</span>
          <span class="value-label">电流:</span>
          <span class="value-data" id="summaryCurrent">--</span>
        </div>
        <div class="value-row">
          <span class="value-label">功率:</span>
          <span class="value-data" id="summaryPower">--</span>
          <span class="value-label">累计:</span>
          <span class="value-data" id="summaryTime">--</span>
        </div>
        <div class="value-row">
          <span class="value-label">D+:</span>
          <span class="value-data" id="dVoltage1">--</span>
          <span class="value-label">D-:</span>
          <span class="value-data" id="dVoltage2">--</span>
        </div>
        <div class="value-row">
          <span class="value-label">Ah积累:</span>
          <span class="value-data" id="summaryAh">--</span>
          <span class="value-label">Wh积累:</span>
          <span class="value-data" id="summaryWh">--</span>
        </div>
        <div class="value-row">
          <span class="value-label">记录组别:</span>
          <span class="value-data" id="type">--</span>
          <span class="value-label"></span>
          <span class="value-data"></span>
        </div>

      </div>
      <div class="value-summary" id="maxSummary">
        <div class="value-row">
          <span class="value-label">最大功率:</span>
          <span class="value-data" id="maxPower">--</span>
        </div>
        <div class="value-row">
          <span class="value-label">最大电流:</span>
          <span class="value-data" id="maxCurrent">--</span>
        </div>
        <div class="value-row">
          <span class="value-label">最大电压:</span>
          <span class="value-data" id="maxVoltage">--</span>
        </div>
      </div>
    </div>
    <div class="main-card">
      <div class="chart-card">
        <div class="chart-title">实时曲线</div>
        <div id="main" style="width: 100%; height: 650px;"></div>
      </div>
      <div class="chart-card">
        <label for="barType" style="font-size:16px;color:#232d3c;">统计类型:</label>
        <select id="barType" class="select">
          <option value="power">功率</option>
          <option value="current">电流</option>
          <option value="voltage">电压</option>
        </select>
        <div class="chart-title">分布统计柱状图</div>
        <div id="powerBarChart" style="width: 100%; height: 400px;"></div>
      </div>
    </div>
  </div>
  <script>
    const btnOpen = document.querySelector("#btnOpen");
    let device;
    let inputDataLength;
    let outputDataLength;

    let chartDom = document.getElementById('main');
    let myChart = echarts.init(chartDom);

    let powerBarChartDom = document.getElementById('powerBarChart');
    let powerBarChart = echarts.init(powerBarChartDom);

    // 添加导入导出按钮
    const exportBtn = document.createElement('button');
    exportBtn.textContent = '导出数据';
    exportBtn.className = 'btn';
    exportBtn.onclick = exportData;
    
    const importBtn = document.createElement('button');
    importBtn.textContent = '导入数据';
    importBtn.className = 'btn';
    importBtn.onclick = importData;
    
    // 将按钮添加到页面中
    const sideCard = document.querySelector('.side-card');
    sideCard.insertBefore(importBtn, sideCard.children[1]);
    sideCard.insertBefore(exportBtn, sideCard.children[1]);

    // 统一颜色
    const colorVoltage = '#4F8FEA';   // 柔和蓝
    const colorCurrent = '#43C59E';   // 清新绿
    const colorPower = '#FFA940';   // 活力橙

    // 功率分布统计桶
    let powerBuckets = {};
    let bucketSize = 1;
    function getPowerBucket(power) {
      return `${Math.floor(power / bucketSize) * bucketSize}~${(Math.floor(power / bucketSize) + 1) * bucketSize}`;
    }

    // 电流分布统计桶
    let currentBuckets = {};
    let currentBucketSize = 1;
    function getCurrentBucket(current) {
      return `${Math.floor(current / currentBucketSize) * currentBucketSize}~${(Math.floor(current / currentBucketSize) + 1) * currentBucketSize}`;
    }

    // 电压分布统计桶
    let voltageBuckets = {};
    let voltageBucketSize = 1;
    function getVoltageBucket(voltage) {
      return `${Math.floor(voltage / voltageBucketSize) * voltageBucketSize}~${(Math.floor(voltage / voltageBucketSize) + 1) * voltageBucketSize}`;
    }

    const barTypeSelect = document.getElementById('barType');

    function updatePowerBarChart() {
      let type = barTypeSelect.value;
      let keys, times, name, color;
      if (type === 'power') {
        keys = Object.keys(powerBuckets).sort((a, b) => parseFloat(a.split('~')[0]) - parseFloat(b.split('~')[0]));
        times = keys.map(k => powerBuckets[k]);
        name = '功率';
        color = colorPower;
      } else if (type === 'current') {
        keys = Object.keys(currentBuckets).sort((a, b) => parseFloat(a.split('~')[0]) - parseFloat(b.split('~')[0]));
        times = keys.map(k => currentBuckets[k]);
        name = '电流';
        color = colorCurrent;
      } else {
        keys = Object.keys(voltageBuckets).sort((a, b) => parseFloat(a.split('~')[0]) - parseFloat(b.split('~')[0]));
        times = keys.map(k => voltageBuckets[k]);
        name = '电压';
        color = colorVoltage;
      }

      powerBarChart.setOption({
        backgroundColor: '#f5f7fa',
        title: { text: `${name}分布（根据采集数统计）`, left: 'center', textStyle: { color: colorVoltage, fontWeight: 500, fontSize: 18 } },
        tooltip: {
          trigger: 'axis',
          formatter: function (params) {
            let tooltipContent = `<div style="color: #232d3c; font-size: 14px;">区间 ${params[0].name} </div>`;
            params.forEach(param => {
              tooltipContent += `<div> ${param.seriesName}区间内采集到:${param.data}次</div>`;
            });
            return tooltipContent;
          }
        },
        xAxis: {
          type: 'category',
          data: keys,
          name: '区间',
          axisLabel: { rotate: 45, color: '#232d3c' },
          axisLine: { lineStyle: { color: '#dbeafe' } }
        },
        yAxis: {
          type: 'value',
          name: '累计',
          axisLabel: { color: '#232d3c' },
          axisLine: { lineStyle: { color: '#dbeafe' } }
        },
        series: [{
          name: name,
          type: 'bar',
          data: times,
          barWidth: 24,
          itemStyle: { color }
        }]
      });
    }

    barTypeSelect.onchange = updatePowerBarChart;

    let times = [];
    let voltages = [];
    let currents = [];
    let powers = [];
    let startTime = null;

    let chartOption = {
      backgroundColor: '#f5f7fa',
      title: {
        text: '电压/电流/功率 实时曲线',
        left: 'center',
        textStyle: { color: colorVoltage, fontWeight: 500, fontSize: 18 }
      },
      tooltip: {
        trigger: 'axis',
        formatter: function (params) {
          var time = formatHMS(params[0].name)
          let tooltipContent = `<div style="color: #232d3c; font-size: 14px;">时间: ${time}</div>`;
          params.forEach(param => {
            tooltipContent += `<div> ${param.seriesName}: ${param.data.toFixed(5)}</div>`;
          });
          return tooltipContent;
        }
      },
      legend: {
        data: ['电压', '电流', '功率'],
        textStyle: { color: '#232d3c', fontSize: 15 },
        bottom: 100,
        orient: 'vertical',
        right: 20,
        itemWidth: 20,
        itemHeight: 10,
        top: 'center',
      },
      xAxis: {
        type: 'category',
        data: times,
        name: '时间',
        axisLabel: {
          color: '#232d3c',
          formatter: function (value) {
            if (typeof value === 'number' || /^\d+$/.test(value)) {
              const sec = Number(value);
              const h = Math.floor(sec / 3600);
              const m = Math.floor((sec % 3600) / 60);
              const s = sec % 60;
              return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
            return value;
          }
        },
        axisLine: { lineStyle: { color: '#dbeafe' } }
      },
      yAxis: {
        type: 'value',
        axisLabel: { color: '#232d3c' },
        axisLine: { lineStyle: { color: '#dbeafe' } }
      },
      series: [
        {
          sampling: 'average',
          name: '电压',
          type: 'line',
          data: voltages,
          showSymbol: false,
          lineStyle: { color: colorVoltage, width: 3 }
        },
        {
          sampling: 'average',
          name: '电流',
          type: 'line',
          data: currents,
          showSymbol: false,
          lineStyle: { color: colorCurrent, width: 3 }
        },
        {
          sampling: 'average',
          name: '功率',
          type: 'line',
          data: powers,
          showSymbol: false,
          lineStyle: { color: colorPower, width: 3 }
        }
      ],
      dataZoom: [
        {
          type: 'slider',
          show: true,
          xAxisIndex: 0,
          start: 0,
          end: 100,
        },
        {
          type: 'inside',
          xAxisIndex: 0,
          start: 0,
          end: 100
        }
      ]
    };

    myChart.setOption(chartOption);

    // 辅助函数：秒转时分秒字符串
    function formatHMS(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return [
        h > 0 ? String(h).padStart(2, '0') : '00',
        String(m).padStart(2, '0'),
        String(s).padStart(2, '0')
      ].join(':');
    }

    // 导出数据功能
    function exportData() {
      // 创建要导出的数据对象
      const exportData = {
        times: times,
        voltages: voltages,
        currents: currents,
        powers: powers,
        powerBuckets: powerBuckets,
        currentBuckets: currentBuckets,
        voltageBuckets: voltageBuckets,
        startTime: startTime,
        maxPower: document.getElementById('maxPower').textContent,
        maxCurrent: document.getElementById('maxCurrent').textContent,
        maxVoltage: document.getElementById('maxVoltage').textContent
      };

      // 创建 Blob 对象
      const dataStr = JSON.stringify(exportData);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      
      // 创建下载链接
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `power-data-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // 导入数据功能
    function importData() {
      // 创建文件输入元素
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.json';
      
      fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            // 断开设备连接（如果已连接）
            if (device) {
              device.close();
              device = null;
            }
            
            // 清空当前所有显示的数据
            clearAllData();
            
            // 解析导入的数据
            const importedData = JSON.parse(e.target.result);
            
            // 恢复数据
            times = importedData.times || [];
            voltages = importedData.voltages || [];
            currents = importedData.currents || [];
            powers = importedData.powers || [];
            powerBuckets = importedData.powerBuckets || {};
            currentBuckets = importedData.currentBuckets || {};
            voltageBuckets = importedData.voltageBuckets || {};
            startTime = importedData.startTime || null;
            
            // 更新图表
            myChart.setOption({
              xAxis: { data: times },
              series: [
                { data: voltages },
                { data: currents },
                { data: powers }
              ]
            });
            
            updatePowerBarChart();
            
            // 更新最大值显示
            document.getElementById('maxPower').textContent = importedData.maxPower || '--';
            document.getElementById('maxCurrent').textContent = importedData.maxCurrent || '--';
            document.getElementById('maxVoltage').textContent = importedData.maxVoltage || '--';
            
          } catch (error) {
            console.error('导入数据失败:', error);
            alert('导入数据失败，请检查文件格式是否正确');
          }
        };
        reader.readAsText(file);
      };
      
      fileInput.click();
    }

    // 清空所有数据显示的函数
    function clearAllData() {
      times = [];
      voltages = [];
      currents = [];
      powers = [];
      powerBuckets = {};
      currentBuckets = {};
      voltageBuckets = {};
      startTime = null;

      
      // 清空所有数值显示
      document.getElementById('summaryVoltage').textContent = '--';
      document.getElementById('summaryCurrent').textContent = '--';
      document.getElementById('summaryPower').textContent = '--';
      document.getElementById('summaryTime').textContent = '--';
      document.getElementById('summaryAh').textContent = '--';
      document.getElementById('summaryWh').textContent = '--';
      document.getElementById('dVoltage1').textContent = '--';
      document.getElementById('dVoltage2').textContent = '--';
      document.getElementById('type').textContent = '--';
      document.getElementById('maxPower').textContent = '--';
      document.getElementById('maxCurrent').textContent = '--';
      document.getElementById('maxVoltage').textContent = '--';
    }

    btnOpen.onclick = async () => {
      try {
        const devices = await navigator.hid.requestDevice({ filters: [] });
        if (devices.length == 0) {
          return;
        }
        device = devices[0];
        if (!device.opened) {
          await device.open();
        }

        startTime = Date.now();
        lastTime = Date.now();
        let updateCount = 0; // 刷新计数器
        const UPDATE_INTERVAL = 5; // 次采集刷新一次图
        const INTERVAL = 100; //  毫秒采集一次

        function updateMaxValues() {
          document.getElementById('maxPower').textContent = powers.length ? Math.max(...powers).toFixed(5) : '--';
          document.getElementById('maxCurrent').textContent = currents.length ? Math.max(...currents.map(Math.abs)).toFixed(5) : '--';
          document.getElementById('maxVoltage').textContent = voltages.length ? Math.max(...voltages).toFixed(5) : '--';
        }

        device.oninputreport = (event) => {
          let now = Date.now();
          var elapsed = now - lastTime;
          if (elapsed >= INTERVAL) {
            lastTime = now;
            times.push(Math.round((now - startTime) / 1000));
            let array = new Uint8Array(event.data.buffer);
            let hexstr = "";
            for (const data of array) {
              hexstr += (Array(2).join(0) + data.toString(16).toUpperCase()).slice(-2) + " ";
            }
            var xx = parsePowerMeterHID(hexstr);

            // 优化数值显示
            document.getElementById('summaryVoltage').textContent = xx.voltage;
            document.getElementById('summaryCurrent').textContent = xx.current;
            document.getElementById('summaryPower').textContent = xx.powerConsistency;
            document.getElementById('summaryTime').textContent = xx.time;
            document.getElementById('summaryAh').textContent = xx.Ah;
            document.getElementById('summaryWh').textContent = xx.Wh;
            document.getElementById('dVoltage1').textContent = xx.dVoltage1;
            document.getElementById('dVoltage2').textContent = xx.dVoltage2;
            document.getElementById('type').textContent = xx.type === 0 ? '1' : '2';

            voltages.push(Number(xx.voltage));
            currents.push(Number(xx.current));
            powers.push(Number(xx.powerConsistency));

            // 功率分布统计
            const powerBucket = getPowerBucket(Number(xx.powerConsistency));
            if (!powerBuckets[powerBucket]) powerBuckets[powerBucket] = 0;
            powerBuckets[powerBucket] += 1;

            // 电流分布统计
            const currentBucket = getCurrentBucket(Number(xx.current));
            if (!currentBuckets[currentBucket]) currentBuckets[currentBucket] = 0;
            currentBuckets[currentBucket] += 1;

            // 电压分布统计
            const voltageBucket = getVoltageBucket(Number(xx.voltage));
            if (!voltageBuckets[voltageBucket]) voltageBuckets[voltageBucket] = 0;
            voltageBuckets[voltageBucket] += 1;

            updateCount++;
            if (updateCount % UPDATE_INTERVAL === 0) {
              // 降低刷新频率
              myChart.setOption({
                xAxis: { data: times },
                series: [
                  { data: voltages },
                  { data: currents },
                  { data: powers }
                ]
              });
              updatePowerBarChart();
            }
            updateMaxValues();
          }
        };
      } catch (error) {
        console.log(error);
      }
    };

    function parsePowerMeterHID(hexString) {
      // 移除所有非十六进制字符（包括行首地址）
      const cleanHex = hexString.replace(/[^0-9a-fA-F]/g, '');

      // 验证长度
      if (cleanHex.length !== 128) { // 64字节 * 2个字符/字节
        throw new Error(`无效的报文长度: ${cleanHex.length} 字符，应为128字符`);
      }

      // 将十六进制字符串转换为字节数组
      const bytes = [];
      for (let i = 0; i < cleanHex.length; i += 2) {
        bytes.push(parseInt(cleanHex.substr(i, 2), 16));
      }

      // 辅助函数：提取小端序浮点数
      const parseFloatLE = (offset) => {
        const buffer = new ArrayBuffer(4);
        const view = new DataView(buffer);
        for (let i = 0; i < 4; i++) {
          view.setUint8(i, bytes[offset + i]);
        }
        return view.getFloat32(0, true);
      };

      // 辅助函数：提取小端序16位整数
      const parseUInt16LE = (offset) => {
        return (bytes[offset + 1] << 8) | bytes[offset];
      };

      // 辅助函数：提取大端序16位整数
      const parseUInt16BE = (offset) => {
        return (bytes[offset] << 8) | bytes[offset + 1];
      };



      const secondsToHMS = (seconds) => {
        // 确保输入是数字
        const totalSeconds = Number(seconds);

        // 计算小时、分钟、剩余秒
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const secs = Math.floor(totalSeconds % 60);

        const parts = [];
        if (hours) parts.push(`${hours}时`);
        if (minutes) parts.push(`${minutes}分`);
        if (secs || parts.length === 0) parts.push(`${secs}秒`);

        return parts.join('');

      }

      // 解析关键字段
      const result = {
        dVoltage1: parseFloatLE(30).toFixed(5),
        dVoltage2: parseFloatLE(34).toFixed(5),
        Ah: parseFloatLE(14).toFixed(5),
        Wh: parseFloatLE(18).toFixed(5),
        voltage: parseFloatLE(46).toFixed(5),
        current:Math.abs(parseFloatLE(50).toFixed(5)),
        time: secondsToHMS(parseUInt16LE(22)),
        type: bytes[54]
      };

      const voltage = parseFloatLE(46);
      const current = parseFloatLE(50);
      const calcPower = (voltage * Math.abs(current)).toFixed(5);
      result.powerConsistency = calcPower

      return result;
    }

  </script>
</body>

</html>